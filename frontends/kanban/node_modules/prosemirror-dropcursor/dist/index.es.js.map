{"version":3,"file":"index.es.js","sources":["../src/dropcursor.js"],"sourcesContent":["import {Plugin} from \"prosemirror-state\"\nimport {dropPoint} from \"prosemirror-transform\"\n\n// :: (options: ?Object) â†’ Plugin\n// Create a plugin that, when added to a ProseMirror instance,\n// causes a decoration to show up at the drop position when something\n// is dragged over the editor.\n//\n// Nodes may add a `disableDropCursor` property to their spec to\n// control the showing of a drop cursor inside them. This may be a\n// boolean or a function, which will be called with a view and a\n// position, and should return a boolean.\n//\n//   options::- These options are supported:\n//\n//     color:: ?string\n//     The color of the cursor. Defaults to `black`.\n//\n//     width:: ?number\n//     The precise width of the cursor in pixels. Defaults to 1.\n//\n//     class:: ?string\n//     A CSS class name to add to the cursor element.\nexport function dropCursor(options = {}) {\n  return new Plugin({\n    view(editorView) { return new DropCursorView(editorView, options) }\n  })\n}\n\nclass DropCursorView {\n  constructor(editorView, options) {\n    this.editorView = editorView\n    this.width = options.width || 1\n    this.color = options.color || \"black\"\n    this.class = options.class\n    this.cursorPos = null\n    this.element = null\n    this.timeout = null\n\n    this.handlers = [\"dragover\", \"dragend\", \"drop\", \"dragleave\"].map(name => {\n      let handler = e => this[name](e)\n      editorView.dom.addEventListener(name, handler)\n      return {name, handler}\n    })\n  }\n\n  destroy() {\n    this.handlers.forEach(({name, handler}) => this.editorView.dom.removeEventListener(name, handler))\n  }\n\n  update(editorView, prevState) {\n    if (this.cursorPos != null && prevState.doc != editorView.state.doc) {\n      if (this.cursorPos > editorView.state.doc.content.size) this.setCursor(null)\n      else this.updateOverlay()\n    }\n  }\n\n  setCursor(pos) {\n    if (pos == this.cursorPos) return\n    this.cursorPos = pos\n    if (pos == null) {\n      this.element.parentNode.removeChild(this.element)\n      this.element = null\n    } else {\n      this.updateOverlay()\n    }\n  }\n\n  updateOverlay() {\n    let $pos = this.editorView.state.doc.resolve(this.cursorPos), rect\n    if (!$pos.parent.inlineContent) {\n      let before = $pos.nodeBefore, after = $pos.nodeAfter\n      if (before || after) {\n        let nodeRect = this.editorView.nodeDOM(this.cursorPos - (before ?  before.nodeSize : 0)).getBoundingClientRect()\n        let top = before ? nodeRect.bottom : nodeRect.top\n        if (before && after)\n          top = (top + this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top) / 2\n        rect = {left: nodeRect.left, right: nodeRect.right, top: top - this.width / 2, bottom: top + this.width / 2}\n      }\n    }\n    if (!rect) {\n      let coords = this.editorView.coordsAtPos(this.cursorPos)\n      rect = {left: coords.left - this.width / 2, right: coords.left + this.width / 2, top: coords.top, bottom: coords.bottom}\n    }\n\n    let parent = this.editorView.dom.offsetParent\n    if (!this.element) {\n      this.element = parent.appendChild(document.createElement(\"div\"))\n      if (this.class) this.element.className = this.class\n      this.element.style.cssText = \"position: absolute; z-index: 50; pointer-events: none; background-color: \" + this.color\n    }\n    let parentLeft, parentTop\n    if (!parent || parent == document.body && getComputedStyle(parent).position == \"static\") {\n      parentLeft = -pageXOffset\n      parentTop = -pageYOffset\n    } else {\n      let rect = parent.getBoundingClientRect()\n      parentLeft = rect.left - parent.scrollLeft\n      parentTop = rect.top - parent.scrollTop\n    }\n    this.element.style.left = (rect.left - parentLeft) + \"px\"\n    this.element.style.top = (rect.top - parentTop) + \"px\"\n    this.element.style.width = (rect.right - rect.left) + \"px\"\n    this.element.style.height = (rect.bottom - rect.top) + \"px\"\n  }\n\n  scheduleRemoval(timeout) {\n    clearTimeout(this.timeout)\n    this.timeout = setTimeout(() => this.setCursor(null), timeout)\n  }\n\n  dragover(event) {\n    if (!this.editorView.editable) return\n    let pos = this.editorView.posAtCoords({left: event.clientX, top: event.clientY})\n\n    let node = pos && pos.inside >= 0 && this.editorView.state.doc.nodeAt(pos.inside)\n    let disableDropCursor = node && node.type.spec.disableDropCursor\n    let disabled = typeof disableDropCursor == \"function\" ? disableDropCursor(this.editorView, pos) : disableDropCursor\n\n    if (pos && !disabled) {\n      let target = pos.pos\n      if (this.editorView.dragging && this.editorView.dragging.slice) {\n        target = dropPoint(this.editorView.state.doc, target, this.editorView.dragging.slice)\n        if (target == null) return this.setCursor(null)\n      }\n      this.setCursor(target)\n      this.scheduleRemoval(5000)\n    }\n  }\n\n  dragend() {\n    this.scheduleRemoval(20)\n  }\n\n  drop() {\n    this.scheduleRemoval(20)\n  }\n\n  dragleave(event) {\n    if (event.target == this.editorView.dom || !this.editorView.dom.contains(event.relatedTarget))\n      this.setCursor(null)\n  }\n}\n"],"names":["let","this","rect"],"mappings":"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"}