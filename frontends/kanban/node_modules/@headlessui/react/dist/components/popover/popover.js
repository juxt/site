import F,{createContext as V,createRef as pe,useContext as $,useEffect as U,useMemo as I,useReducer as fe,useRef as Y,useState as Pe}from"react";import{match as H}from'../../utils/match.js';import{forwardRefWithAs as W,render as j,Features as q}from'../../utils/render.js';import{optionalRef as de,useSyncRefs as x}from'../../hooks/use-sync-refs.js';import{useId as G}from'../../hooks/use-id.js';import{Keys as h}from'../keyboard.js';import{isDisabledReactIssue7711 as se}from'../../utils/bugs.js';import{getFocusableElements as ve,Focus as k,focusIn as _,isFocusableElement as Te,FocusableMode as me}from'../../utils/focus-management.js';import{OpenClosedProvider as ye,State as z,useOpenClosed as ie}from'../../internal/open-closed.js';import{useResolveButtonType as Ee}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as Se}from'../../hooks/use-outside-click.js';import{getOwnerDocument as be}from'../../utils/owner.js';import{useOwnerDocument as Q}from'../../hooks/use-owner.js';import{useEventListener as ge}from'../../hooks/use-event-listener.js';import{Hidden as X,Features as Z}from'../../internal/hidden.js';import{useEvent as b}from'../../hooks/use-event.js';import{useTabDirection as ue,Direction as w}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';var Ae=(c=>(c[c.Open=0]="Open",c[c.Closed=1]="Closed",c))(Ae||{}),Ce=(n=>(n[n.TogglePopover=0]="TogglePopover",n[n.ClosePopover=1]="ClosePopover",n[n.SetButton=2]="SetButton",n[n.SetButtonId=3]="SetButtonId",n[n.SetPanel=4]="SetPanel",n[n.SetPanelId=5]="SetPanelId",n))(Ce||{});let Re={[0]:r=>({...r,popoverState:H(r.popoverState,{[0]:1,[1]:0})}),[1](r){return r.popoverState===1?r:{...r,popoverState:1}},[2](r,t){return r.button===t.button?r:{...r,button:t.button}},[3](r,t){return r.buttonId===t.buttonId?r:{...r,buttonId:t.buttonId}},[4](r,t){return r.panel===t.panel?r:{...r,panel:t.panel}},[5](r,t){return r.panelId===t.panelId?r:{...r,panelId:t.panelId}}},ee=V(null);ee.displayName="PopoverContext";function J(r){let t=$(ee);if(t===null){let c=new Error(`<${r} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(c,J),c}return t}let te=V(null);te.displayName="PopoverAPIContext";function oe(r){let t=$(te);if(t===null){let c=new Error(`<${r} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(c,oe),c}return t}let re=V(null);re.displayName="PopoverGroupContext";function ce(){return $(re)}let ne=V(null);ne.displayName="PopoverPanelContext";function Oe(){return $(ne)}function Me(r,t){return H(t.type,Re,r,t)}let Le="div",Fe=W(function(t,c){var R;let o=`headlessui-popover-button-${G()}`,d=`headlessui-popover-panel-${G()}`,a=Y(null),n=x(c,de(e=>{a.current=e})),g=fe(Me,{popoverState:1,button:null,buttonId:o,panel:null,panelId:d,beforePanelSentinel:pe(),afterPanelSentinel:pe()}),[{popoverState:m,button:l,panel:v,beforePanelSentinel:p,afterPanelSentinel:B},s]=g,T=Q((R=a.current)!=null?R:l);U(()=>s({type:3,buttonId:o}),[o,s]),U(()=>s({type:5,panelId:d}),[d,s]);let f=I(()=>{if(!l||!v)return!1;for(let e of document.querySelectorAll("body > *"))if(Number(e==null?void 0:e.contains(l))^Number(e==null?void 0:e.contains(v)))return!0;return!1},[l,v]),P=I(()=>({buttonId:o,panelId:d,close:()=>s({type:1})}),[o,d,s]),y=ce(),A=y==null?void 0:y.registerPopover,M=b(()=>{var e;return(e=y==null?void 0:y.isFocusWithinPopoverGroup())!=null?e:(T==null?void 0:T.activeElement)&&((l==null?void 0:l.contains(T.activeElement))||(v==null?void 0:v.contains(T.activeElement)))});U(()=>A==null?void 0:A(P),[A,P]),ge(T==null?void 0:T.defaultView,"focus",e=>{var i,S,O,N;m===0&&(M()||!l||!v||(S=(i=p.current)==null?void 0:i.contains)!=null&&S.call(i,e.target)||(N=(O=B.current)==null?void 0:O.contains)!=null&&N.call(O,e.target)||s({type:1}))},!0),Se([l,v],(e,i)=>{s({type:1}),Te(i,me.Loose)||(e.preventDefault(),l==null||l.focus())},m===0);let L=b(e=>{s({type:1});let i=(()=>e?e instanceof HTMLElement?e:"current"in e&&e.current instanceof HTMLElement?e.current:l:l)();i==null||i.focus()}),D=I(()=>({close:L,isPortalled:f}),[L,f]),u=I(()=>({open:m===0,close:L}),[m,L]),E=t,C={ref:n};return F.createElement(ee.Provider,{value:g},F.createElement(te.Provider,{value:D},F.createElement(ye,{value:H(m,{[0]:z.Open,[1]:z.Closed})},j({ourProps:C,theirProps:E,slot:u,defaultTag:Le,name:"Popover"}))))}),Ie="button",Be=W(function(t,c){let[o,d]=J("Popover.Button"),{isPortalled:a}=oe("Popover.Button"),n=Y(null),g=`headlessui-focus-sentinel-${G()}`,m=ce(),l=m==null?void 0:m.closeOthers,v=Oe(),p=v===null?!1:v===o.panelId,B=x(n,c,p?null:e=>d({type:2,button:e})),s=x(n,c),T=Q(n),f=b(e=>{var i,S,O;if(p){if(o.popoverState===1)return;switch(e.key){case h.Space:case h.Enter:e.preventDefault(),(S=(i=e.target).click)==null||S.call(i),d({type:1}),(O=o.button)==null||O.focus();break}}else switch(e.key){case h.Space:case h.Enter:e.preventDefault(),e.stopPropagation(),o.popoverState===1&&(l==null||l(o.buttonId)),d({type:0});break;case h.Escape:if(o.popoverState!==0)return l==null?void 0:l(o.buttonId);if(!n.current||(T==null?void 0:T.activeElement)&&!n.current.contains(T.activeElement))return;e.preventDefault(),e.stopPropagation(),d({type:1});break}}),P=b(e=>{p||e.key===h.Space&&e.preventDefault()}),y=b(e=>{var i,S;se(e.currentTarget)||t.disabled||(p?(d({type:1}),(i=o.button)==null||i.focus()):(e.preventDefault(),e.stopPropagation(),o.popoverState===1&&(l==null||l(o.buttonId)),d({type:0}),(S=o.button)==null||S.focus()))}),A=b(e=>{e.preventDefault(),e.stopPropagation()}),M=o.popoverState===0,L=I(()=>({open:M}),[M]),D=Ee(t,n),u=t,E=p?{ref:s,type:D,onKeyDown:f,onClick:y}:{ref:B,id:o.buttonId,type:D,"aria-expanded":t.disabled?void 0:o.popoverState===0,"aria-controls":o.panel?o.panelId:void 0,onKeyDown:f,onKeyUp:P,onClick:y,onMouseDown:A},C=ue(),R=b(()=>{let e=o.panel;if(!e)return;function i(){H(C.current,{[w.Forwards]:()=>_(e,k.First),[w.Backwards]:()=>_(e,k.Last)})}i()});return F.createElement(F.Fragment,null,j({ourProps:E,theirProps:u,slot:L,defaultTag:Ie,name:"Popover.Button"}),M&&!p&&a&&F.createElement(X,{id:g,features:Z.Focusable,as:"button",type:"button",onFocus:R}))}),he="div",De=q.RenderStrategy|q.Static,He=W(function(t,c){let[{popoverState:o},d]=J("Popover.Overlay"),a=x(c),n=`headlessui-popover-overlay-${G()}`,g=ie(),m=(()=>g!==null?g===z.Open:o===0)(),l=b(s=>{if(se(s.currentTarget))return s.preventDefault();d({type:1})}),v=I(()=>({open:o===0}),[o]);return j({ourProps:{ref:a,id:n,"aria-hidden":!0,onClick:l},theirProps:t,slot:v,defaultTag:he,features:De,visible:m,name:"Popover.Overlay"})}),xe="div",Ge=q.RenderStrategy|q.Static,ke=W(function(t,c){let{focus:o=!1,...d}=t,[a,n]=J("Popover.Panel"),{close:g,isPortalled:m}=oe("Popover.Panel"),l=`headlessui-focus-sentinel-before-${G()}`,v=`headlessui-focus-sentinel-after-${G()}`,p=Y(null),B=x(p,c,u=>{n({type:4,panel:u})}),s=Q(p),T=ie(),f=(()=>T!==null?T===z.Open:a.popoverState===0)(),P=b(u=>{var E;switch(u.key){case h.Escape:if(a.popoverState!==0||!p.current||(s==null?void 0:s.activeElement)&&!p.current.contains(s.activeElement))return;u.preventDefault(),u.stopPropagation(),n({type:1}),(E=a.button)==null||E.focus();break}});U(()=>{var u;t.static||a.popoverState===1&&((u=t.unmount)!=null?u:!0)&&n({type:4,panel:null})},[a.popoverState,t.unmount,t.static,n]),U(()=>{if(!o||a.popoverState!==0||!p.current)return;let u=s==null?void 0:s.activeElement;p.current.contains(u)||_(p.current,k.First)},[o,p,a.popoverState]);let y=I(()=>({open:a.popoverState===0,close:g}),[a,g]),A={ref:B,id:a.panelId,onKeyDown:P,onBlur:o&&a.popoverState===0?u=>{var C,R,e,i,S;let E=u.relatedTarget;!E||!p.current||(C=p.current)!=null&&C.contains(E)||(n({type:1}),(((e=(R=a.beforePanelSentinel.current)==null?void 0:R.contains)==null?void 0:e.call(R,E))||((S=(i=a.afterPanelSentinel.current)==null?void 0:i.contains)==null?void 0:S.call(i,E)))&&E.focus({preventScroll:!0}))}:void 0,tabIndex:-1},M=ue(),L=b(()=>{let u=p.current;if(!u)return;function E(){H(M.current,{[w.Forwards]:()=>{_(u,k.First)},[w.Backwards]:()=>{var C;(C=a.button)==null||C.focus({preventScroll:!0})}})}E()}),D=b(()=>{let u=p.current;if(!u)return;function E(){H(M.current,{[w.Forwards]:()=>{var O,N,le;if(!a.button)return;let C=ve(),R=C.indexOf(a.button),e=C.slice(0,R+1),S=[...C.slice(R+1),...e];for(let K of S.slice())if(((N=(O=K==null?void 0:K.id)==null?void 0:O.startsWith)==null?void 0:N.call(O,"headlessui-focus-sentinel-"))||((le=a.panel)==null?void 0:le.contains(K))){let ae=S.indexOf(K);ae!==-1&&S.splice(ae,1)}_(S,k.First,!1)},[w.Backwards]:()=>_(u,k.Last)})}E()});return F.createElement(ne.Provider,{value:a.panelId},f&&m&&F.createElement(X,{id:l,ref:a.beforePanelSentinel,features:Z.Focusable,as:"button",type:"button",onFocus:L}),j({ourProps:A,theirProps:d,slot:y,defaultTag:xe,features:Ge,visible:f,name:"Popover.Panel"}),f&&m&&F.createElement(X,{id:v,ref:a.afterPanelSentinel,features:Z.Focusable,as:"button",type:"button",onFocus:D}))}),_e="div",we=W(function(t,c){let o=Y(null),d=x(o,c),[a,n]=Pe([]),g=b(f=>{n(P=>{let y=P.indexOf(f);if(y!==-1){let A=P.slice();return A.splice(y,1),A}return P})}),m=b(f=>(n(P=>[...P,f]),()=>g(f))),l=b(()=>{var y;let f=be(o);if(!f)return!1;let P=f.activeElement;return(y=o.current)!=null&&y.contains(P)?!0:a.some(A=>{var M,L;return((M=f.getElementById(A.buttonId))==null?void 0:M.contains(P))||((L=f.getElementById(A.panelId))==null?void 0:L.contains(P))})}),v=b(f=>{for(let P of a)P.buttonId!==f&&P.close()}),p=I(()=>({registerPopover:m,unregisterPopover:g,isFocusWithinPopoverGroup:l,closeOthers:v}),[m,g,l,v]),B=I(()=>({}),[]),s=t,T={ref:d};return F.createElement(re.Provider,{value:p},j({ourProps:T,theirProps:s,slot:B,defaultTag:_e,name:"Popover.Group"}))}),mt=Object.assign(Fe,{Button:Be,Overlay:He,Panel:ke,Group:we});export{mt as Popover};
