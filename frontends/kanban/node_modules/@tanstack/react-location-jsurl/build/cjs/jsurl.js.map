{"version":3,"file":"jsurl.js","sources":["../../src/jsurl.ts"],"sourcesContent":["// We're inlining our own version of qss here for compression's sake, but we've included it as a hard dependency for the MIT license it requires.\n// Types are naive, but at least it compiles!\n\n// Unreserved characters for URL encoding are: - . _ ~\n// Earlier versions of this library used a different encoding for strings, but in our version we use a period for the string delimiter.\nconst previousStringPrefixes = [\"'\"] as const\nconst stringPrefix = '-'\n\nexport function stringify(v: any): string {\n  function encode(s: any) {\n    return !/[^\\w-.]/.test(s)\n      ? s\n      : s.replace(/[^\\w-.]/g, function (ch: any) {\n          if (ch === '$') return '!'\n          ch = ch.charCodeAt(0)\n          // thanks to Douglas Crockford for the negative slice trick\n          return ch < 0x100\n            ? '*' + ('00' + ch.toString(16)).slice(-2)\n            : '**' + ('0000' + ch.toString(16)).slice(-4)\n        })\n  }\n\n  var tmpAry\n\n  switch (typeof v) {\n    case 'number':\n      return isFinite(v) ? '~' + v : '~null'\n    case 'boolean':\n      return '~' + v\n    case 'string':\n      return '~' + stringPrefix + encode(v)\n    case 'object':\n      if (!v) return '~null'\n\n      tmpAry = []\n\n      if (Array.isArray(v)) {\n        for (var i = 0; i < v.length; i++) {\n          tmpAry[i] = stringify(v[i]!) || '~null'\n        }\n\n        return '~(' + (tmpAry.join('') || '~') + ')'\n      } else {\n        for (var key in v) {\n          if (v.hasOwnProperty(key)) {\n            var val = stringify(v[key]!)\n\n            // skip undefined and functions\n            if (val) {\n              tmpAry.push(encode(key) + val)\n            }\n          }\n        }\n\n        return '~(' + tmpAry.join('~') + ')'\n      }\n    default:\n      // function, undefined\n      return ''\n  }\n}\n\nvar reserved: Record<string, boolean | null> = {\n  true: true,\n  false: false,\n  null: null,\n} as const\n\nexport function parse(s: string): unknown {\n  if (!s) return s\n  s = s.replace(/%(25)*27/g, \"'\")\n  var i = 0,\n    len = s.length\n\n  function eat(expected: any) {\n    if (s.charAt(i) !== expected) {\n      // throw new Error(\n      //   'bad JSURL syntax: expected ' +\n      //     expected +\n      //     ', got ' +\n      //     (s && s.charAt(i)),\n      // )\n      throw new Error()\n    }\n    i++\n  }\n\n  function decode() {\n    var beg = i,\n      ch,\n      r = ''\n    while (i < len && (ch = s.charAt(i)) !== '~' && ch !== ')') {\n      switch (ch) {\n        case '*':\n          if (beg < i) r += s.substring(beg, i)\n          if (s.charAt(i + 1) === '*')\n            (r += String.fromCharCode(parseInt(s.substring(i + 2, i + 6), 16))),\n              (beg = i += 6)\n          else\n            (r += String.fromCharCode(parseInt(s.substring(i + 1, i + 3), 16))),\n              (beg = i += 3)\n          break\n        case '!':\n          if (beg < i) r += s.substring(beg, i)\n          ;(r += '$'), (beg = ++i)\n          break\n        default:\n          i++\n      }\n    }\n    return r + s.substring(beg, i)\n  }\n\n  return (function parseOne(): any {\n    var result: any, ch, beg\n    eat('~')\n    const current = (ch = s.charAt(i))\n    if (current === '(') {\n      i++\n      if (s.charAt(i) === '~') {\n        result = []\n        if (s.charAt(i + 1) === ')') i++\n        else {\n          do {\n            result.push(parseOne())\n          } while (s.charAt(i) === '~')\n        }\n      } else {\n        result = {}\n        if (s.charAt(i) !== ')') {\n          do {\n            var key = decode()\n            result[key] = parseOne()\n          } while (s.charAt(i) === '~' && ++i)\n        }\n      }\n      eat(')')\n    } else if ([stringPrefix, ...previousStringPrefixes].includes(current)) {\n      i++\n      result = decode()\n    } else {\n      beg = i++\n      while (i < len && /[^)~]/.test(s.charAt(i))) i++\n      var sub: string = s.substring(beg, i)\n      if (/[\\d\\-]/.test(ch)) {\n        result = parseFloat(sub)\n      } else {\n        result = reserved[sub]\n        if (typeof result === 'undefined') {\n          // throw new Error('bad value keyword: ' + sub)\n          throw new Error()\n        }\n      }\n    }\n    return result\n  })()\n}\n\nexport function tryParse<T>(s: string, def: any): unknown | T {\n  try {\n    return parse(s)\n  } catch (ex) {\n    return def\n  }\n}\n"],"names":["previousStringPrefixes","stringPrefix","stringify","v","encode","s","test","replace","ch","charCodeAt","toString","slice","tmpAry","isFinite","Array","isArray","i","length","join","key","hasOwnProperty","val","push","reserved","parse","len","eat","expected","charAt","Error","decode","beg","r","substring","String","fromCharCode","parseInt","parseOne","result","current","includes","sub","parseFloat"],"mappings":"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"}