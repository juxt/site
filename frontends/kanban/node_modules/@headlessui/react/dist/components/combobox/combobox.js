import H,{Fragment as pe,createContext as Q,createRef as se,useCallback as be,useContext as Y,useMemo as P,useReducer as de,useRef as E}from"react";import{useComputed as W}from'../../hooks/use-computed.js';import{useDisposables as Z}from'../../hooks/use-disposables.js';import{useEvent as O}from'../../hooks/use-event.js';import{useId as U}from'../../hooks/use-id.js';import{useIsoMorphicEffect as h}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as ce}from'../../hooks/use-latest-value.js';import{useOutsideClick as fe}from'../../hooks/use-outside-click.js';import{useResolveButtonType as me}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as G}from'../../hooks/use-sync-refs.js';import{useTreeWalker as Te}from'../../hooks/use-tree-walker.js';import{calculateActiveIndex as xe,Focus as R}from'../../utils/calculate-active-index.js';import{disposables as z}from'../../utils/disposables.js';import{forwardRefWithAs as F,render as _,compact as Oe,Features as ee}from'../../utils/render.js';import{isDisabledReactIssue7711 as Ce}from'../../utils/bugs.js';import{match as k}from'../../utils/match.js';import{objectToFormEntries as ge}from'../../utils/form.js';import{sortByDomNode as Re}from'../../utils/focus-management.js';import{Hidden as ve,Features as ye}from'../../internal/hidden.js';import{useOpenClosed as Se,State as X,OpenClosedProvider as Ae}from'../../internal/open-closed.js';import{Keys as v}from'../keyboard.js';import{useControllable as Pe}from'../../hooks/use-controllable.js';import{useWatch as Ee}from'../../hooks/use-watch.js';var Ie=(r=>(r[r.Open=0]="Open",r[r.Closed=1]="Closed",r))(Ie||{}),De=(r=>(r[r.Single=0]="Single",r[r.Multi=1]="Multi",r))(De||{}),Ve=(r=>(r[r.Pointer=0]="Pointer",r[r.Other=1]="Other",r))(Ve||{}),Me=(t=>(t[t.OpenCombobox=0]="OpenCombobox",t[t.CloseCombobox=1]="CloseCombobox",t[t.GoToOption=2]="GoToOption",t[t.RegisterOption=3]="RegisterOption",t[t.UnregisterOption=4]="UnregisterOption",t))(Me||{});function $(n,a=r=>r){let r=n.activeOptionIndex!==null?n.options[n.activeOptionIndex]:null,e=Re(a(n.options.slice()),t=>t.dataRef.current.domRef.current),l=r?e.indexOf(r):null;return l===-1&&(l=null),{options:e,activeOptionIndex:l}}let Le={[1](n){return n.dataRef.current.disabled||n.comboboxState===1?n:{...n,activeOptionIndex:null,comboboxState:1}},[0](n){if(n.dataRef.current.disabled||n.comboboxState===0)return n;let a=n.activeOptionIndex,{isSelected:r}=n.dataRef.current,e=n.options.findIndex(l=>r(l.dataRef.current.value));return e!==-1&&(a=e),{...n,comboboxState:0,activeOptionIndex:a}},[2](n,a){var l;if(n.dataRef.current.disabled||n.dataRef.current.optionsRef.current&&!n.dataRef.current.optionsPropsRef.current.static&&n.comboboxState===1)return n;let r=$(n);if(r.activeOptionIndex===null){let t=r.options.findIndex(p=>!p.dataRef.current.disabled);t!==-1&&(r.activeOptionIndex=t)}let e=xe(a,{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:t=>t.id,resolveDisabled:t=>t.dataRef.current.disabled});return{...n,...r,activeOptionIndex:e,activationTrigger:(l=a.trigger)!=null?l:1}},[3]:(n,a)=>{let r={id:a.id,dataRef:a.dataRef},e=$(n,t=>[...t,r]);n.activeOptionIndex===null&&n.dataRef.current.isSelected(a.dataRef.current.value)&&(e.activeOptionIndex=e.options.indexOf(r));let l={...n,...e,activationTrigger:1};return n.dataRef.current.__demoMode&&n.dataRef.current.value===void 0&&(l.activeOptionIndex=0),l},[4]:(n,a)=>{let r=$(n,e=>{let l=e.findIndex(t=>t.id===a.id);return l!==-1&&e.splice(l,1),e});return{...n,...r,activationTrigger:1}}},J=Q(null);J.displayName="ComboboxActionsContext";function j(n){let a=Y(J);if(a===null){let r=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,j),r}return a}let q=Q(null);q.displayName="ComboboxDataContext";function w(n){let a=Y(q);if(a===null){let r=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,w),r}return a}function he(n,a){return k(a.type,Le,n,a)}let Fe=pe;function _e(n,a){let{value:r,defaultValue:e,onChange:l,name:t,by:p=(b,f)=>b===f,disabled:m=!1,__demoMode:o=!1,nullable:i=!1,multiple:C=!1,...y}=n,[x,g]=Pe(r,l,e),[c,s]=de(he,{dataRef:se(),comboboxState:o?0:1,options:[],activeOptionIndex:null,activationTrigger:1}),T=E(!1),B=E({static:!1,hold:!1}),D=E(null),I=E(null),V=E(null),d=E(null),S=O(typeof p=="string"?(b,f)=>{let A=p;return(b==null?void 0:b[A])===(f==null?void 0:f[A])}:p),M=be(b=>k(u.mode,{[1]:()=>x.some(f=>S(f,b)),[0]:()=>S(x,b)}),[x]),u=P(()=>({...c,optionsPropsRef:B,labelRef:D,inputRef:I,buttonRef:V,optionsRef:d,value:x,disabled:m,mode:C?1:0,get activeOptionIndex(){if(T.current&&c.activeOptionIndex===null&&c.options.length>0){let b=c.options.findIndex(f=>!f.dataRef.current.disabled);if(b!==-1)return b}return c.activeOptionIndex},compare:S,isSelected:M,nullable:i,__demoMode:o}),[x,m,C,i,o,c]);h(()=>{c.dataRef.current=u},[u]),fe([u.buttonRef,u.inputRef,u.optionsRef],()=>s({type:1}),u.comboboxState===0);let L=P(()=>({open:u.comboboxState===0,disabled:m,activeIndex:u.activeOptionIndex,activeOption:u.activeOptionIndex===null?null:u.options[u.activeOptionIndex].dataRef.current.value,value:x}),[u,m,x]),N=O(b=>{let f=u.options.find(A=>A.id===b);!f||K(f.dataRef.current.value)}),oe=O(()=>{if(u.activeOptionIndex!==null){let{dataRef:b,id:f}=u.options[u.activeOptionIndex];K(b.current.value),s({type:2,focus:R.Specific,id:f})}}),te=O(()=>{s({type:0}),T.current=!0}),ne=O(()=>{s({type:1}),T.current=!1}),re=O((b,f,A)=>(T.current=!1,b===R.Specific?s({type:2,focus:R.Specific,id:f,trigger:A}):s({type:2,focus:b,trigger:A}))),ae=O((b,f)=>(s({type:3,id:b,dataRef:f}),()=>s({type:4,id:b}))),K=O(b=>k(u.mode,{[0](){return g==null?void 0:g(b)},[1](){let f=u.value.slice(),A=f.findIndex(ue=>S(ue,b));return A===-1?f.push(b):f.splice(A,1),g==null?void 0:g(f)}})),le=P(()=>({onChange:K,registerOption:ae,goToOption:re,closeCombobox:ne,openCombobox:te,selectActiveOption:oe,selectOption:N}),[]),ie=a===null?{}:{ref:a};return H.createElement(J.Provider,{value:le},H.createElement(q.Provider,{value:u},H.createElement(Ae,{value:k(u.comboboxState,{[0]:X.Open,[1]:X.Closed})},t!=null&&x!=null&&ge({[t]:x}).map(([b,f])=>H.createElement(ve,{features:ye.Hidden,...Oe({key:b,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:b,value:f})})),_({ourProps:ie,theirProps:y,slot:L,defaultTag:Fe,name:"Combobox"}))))}let ke=F(_e),we="input",Be=F(function(a,r){var I,V;let{value:e,onChange:l,displayValue:t,type:p="text",...m}=a,o=w("Combobox.Input"),i=j("Combobox.Input"),C=G(o.inputRef,r),y=`headlessui-combobox-input-${U()}`,x=Z(),g=P(()=>{var d;return typeof t=="function"?(d=t(o.value))!=null?d:"":typeof o.value=="string"?o.value:""},[o.value]);Ee(([d,S],[M,u])=>{!o.inputRef.current||(u===0&&S===1||d!==M)&&(o.inputRef.current.value=d)},[g,o.comboboxState]);let c=O(d=>{switch(d.key){case v.Backspace:case v.Delete:if(o.mode!==0||!o.nullable)return;let S=d.currentTarget;x.requestAnimationFrame(()=>{S.value===""&&(i.onChange(null),o.optionsRef.current&&(o.optionsRef.current.scrollTop=0),i.goToOption(R.Nothing))});break;case v.Enter:if(o.comboboxState!==0)return;if(d.preventDefault(),d.stopPropagation(),o.activeOptionIndex===null){i.closeCombobox();return}i.selectActiveOption(),o.mode===0&&i.closeCombobox();break;case v.ArrowDown:return d.preventDefault(),d.stopPropagation(),k(o.comboboxState,{[0]:()=>{i.goToOption(R.Next)},[1]:()=>{i.openCombobox()}});case v.ArrowUp:return d.preventDefault(),d.stopPropagation(),k(o.comboboxState,{[0]:()=>{i.goToOption(R.Previous)},[1]:()=>{i.openCombobox(),x.nextFrame(()=>{o.value||i.goToOption(R.Last)})}});case v.Home:case v.PageUp:return d.preventDefault(),d.stopPropagation(),i.goToOption(R.First);case v.End:case v.PageDown:return d.preventDefault(),d.stopPropagation(),i.goToOption(R.Last);case v.Escape:return o.comboboxState!==0?void 0:(d.preventDefault(),o.optionsRef.current&&!o.optionsPropsRef.current.static&&d.stopPropagation(),i.closeCombobox());case v.Tab:if(o.comboboxState!==0)return;o.mode===0&&i.selectActiveOption(),i.closeCombobox();break}}),s=O(d=>{i.openCombobox(),l==null||l(d)}),T=W(()=>{if(!!o.labelRef.current)return[o.labelRef.current.id].join(" ")},[o.labelRef.current]),B=P(()=>({open:o.comboboxState===0,disabled:o.disabled}),[o]),D={ref:C,id:y,role:"combobox",type:p,"aria-controls":(I=o.optionsRef.current)==null?void 0:I.id,"aria-expanded":o.disabled?void 0:o.comboboxState===0,"aria-activedescendant":o.activeOptionIndex===null||(V=o.options[o.activeOptionIndex])==null?void 0:V.id,"aria-multiselectable":o.mode===1?!0:void 0,"aria-labelledby":T,disabled:o.disabled,onKeyDown:c,onChange:s};return _({ourProps:D,theirProps:m,slot:B,defaultTag:we,name:"Combobox.Input"})}),Ue="button",Ge=F(function(a,r){var c;let e=w("Combobox.Button"),l=j("Combobox.Button"),t=G(e.buttonRef,r),p=`headlessui-combobox-button-${U()}`,m=Z(),o=O(s=>{switch(s.key){case v.ArrowDown:return s.preventDefault(),s.stopPropagation(),e.comboboxState===1&&l.openCombobox(),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})});case v.ArrowUp:return s.preventDefault(),s.stopPropagation(),e.comboboxState===1&&(l.openCombobox(),m.nextFrame(()=>{e.value||l.goToOption(R.Last)})),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})});case v.Escape:return e.comboboxState!==0?void 0:(s.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&s.stopPropagation(),l.closeCombobox(),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})}));default:return}}),i=O(s=>{if(Ce(s.currentTarget))return s.preventDefault();e.comboboxState===0?l.closeCombobox():(s.preventDefault(),l.openCombobox()),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})})}),C=W(()=>{if(!!e.labelRef.current)return[e.labelRef.current.id,p].join(" ")},[e.labelRef.current,p]),y=P(()=>({open:e.comboboxState===0,disabled:e.disabled,value:e.value}),[e]),x=a,g={ref:t,id:p,type:me(a,e.buttonRef),tabIndex:-1,"aria-haspopup":!0,"aria-controls":(c=e.optionsRef.current)==null?void 0:c.id,"aria-expanded":e.disabled?void 0:e.comboboxState===0,"aria-labelledby":C,disabled:e.disabled,onClick:i,onKeyDown:o};return _({ourProps:g,theirProps:x,slot:y,defaultTag:Ue,name:"Combobox.Button"})}),Ne="label",He=F(function(a,r){let e=w("Combobox.Label"),l=`headlessui-combobox-label-${U()}`,t=G(e.labelRef,r),p=O(()=>{var C;return(C=e.inputRef.current)==null?void 0:C.focus({preventScroll:!0})}),m=P(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]);return _({ourProps:{ref:t,id:l,onClick:p},theirProps:a,slot:m,defaultTag:Ne,name:"Combobox.Label"})}),je="ul",Ke=ee.RenderStrategy|ee.Static,We=F(function(a,r){var g;let{hold:e=!1,...l}=a,t=w("Combobox.Options"),p=G(t.optionsRef,r),m=`headlessui-combobox-options-${U()}`,o=Se(),i=(()=>o!==null?o===X.Open:t.comboboxState===0)();h(()=>{var c;t.optionsPropsRef.current.static=(c=a.static)!=null?c:!1},[t.optionsPropsRef,a.static]),h(()=>{t.optionsPropsRef.current.hold=e},[t.optionsPropsRef,e]),Te({container:t.optionsRef.current,enabled:t.comboboxState===0,accept(c){return c.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:c.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(c){c.setAttribute("role","none")}});let C=W(()=>{var c,s,T;return(T=(c=t.labelRef.current)==null?void 0:c.id)!=null?T:(s=t.buttonRef.current)==null?void 0:s.id},[t.labelRef.current,t.buttonRef.current]),y=P(()=>({open:t.comboboxState===0}),[t]),x={"aria-activedescendant":t.activeOptionIndex===null||(g=t.options[t.activeOptionIndex])==null?void 0:g.id,"aria-labelledby":C,role:"listbox",id:m,ref:p};return _({ourProps:x,theirProps:l,slot:y,defaultTag:je,features:Ke,visible:i,name:"Combobox.Options"})}),Xe="li",$e=F(function(a,r){var S,M;let{disabled:e=!1,value:l,...t}=a,p=w("Combobox.Option"),m=j("Combobox.Option"),o=`headlessui-combobox-option-${U()}`,i=p.activeOptionIndex!==null?p.options[p.activeOptionIndex].id===o:!1,C=p.isSelected(l),y=E(null),x=ce({disabled:e,value:l,domRef:y,textValue:(M=(S=y.current)==null?void 0:S.textContent)==null?void 0:M.toLowerCase()}),g=G(r,y),c=O(()=>m.selectOption(o));h(()=>m.registerOption(o,x),[x,o]);let s=E(!p.__demoMode);h(()=>{if(!p.__demoMode)return;let u=z();return u.requestAnimationFrame(()=>{s.current=!0}),u.dispose},[]),h(()=>{if(p.comboboxState!==0||!i||!s.current||p.activationTrigger===0)return;let u=z();return u.requestAnimationFrame(()=>{var L,N;(N=(L=y.current)==null?void 0:L.scrollIntoView)==null||N.call(L,{block:"nearest"})}),u.dispose},[y,i,p.comboboxState,p.activationTrigger,p.activeOptionIndex]);let T=O(u=>{if(e)return u.preventDefault();c(),p.mode===0&&m.closeCombobox()}),B=O(()=>{if(e)return m.goToOption(R.Nothing);m.goToOption(R.Specific,o)}),D=O(()=>{e||i||m.goToOption(R.Specific,o,0)}),I=O(()=>{e||!i||p.optionsPropsRef.current.hold||m.goToOption(R.Nothing)}),V=P(()=>({active:i,selected:C,disabled:e}),[i,C,e]);return _({ourProps:{id:o,ref:g,role:"option",tabIndex:e===!0?void 0:-1,"aria-disabled":e===!0?!0:void 0,"aria-selected":C,disabled:void 0,onClick:T,onFocus:B,onPointerMove:D,onMouseMove:D,onPointerLeave:I,onMouseLeave:I},theirProps:t,slot:V,defaultTag:Xe,name:"Combobox.Option"})}),Do=Object.assign(ke,{Input:Be,Button:Ge,Label:He,Options:We,Option:$e});export{Do as Combobox};
